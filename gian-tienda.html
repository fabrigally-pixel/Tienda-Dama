<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - SHOWROOM</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #fdf6f0; padding: 20px; margin: 0; display: flex; flex-direction: column; align-items: center; }
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; width: 100%; max-width: 500px; }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; cursor: pointer; background: #e0e0e0; font-weight: bold; }
        .tab-btn.active { background: #d4a373; color: white; }
        .section { display: none; width: 100%; max-width: 500px; }
        .section.active { display: block; }
        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid #f0e4d7; margin-bottom: 20px; width: 100%; box-sizing: border-box; }
        label { display: block; margin-top: 10px; font-weight: 600; color: #777; font-size: 11px; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #f0e4d7; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        .price-box { background: #fdf6f0; padding: 15px; border-radius: 12px; text-align: center; margin: 10px 0; border: 1px dashed #d4a373; }
        .btn-main { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .prod-item { display:flex; align-items:center; gap:10px; border-bottom:1px solid #eee; padding:10px 0; }
        .order-card { background: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; border-left: 5px solid #d4a373; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('carga', this)">üì¶ Stock</button>
    <button class="tab-btn" onclick="switchTab('pedidos', this)">üõçÔ∏è Pedidos</button>
</div>

<div id="sec-carga" class="section active">
    <div class="card">
        <h2 id="form-title" style="margin:0; color:#d4a373;">Gestionar Prenda</h2>
        <input type="hidden" id="edit-id">
        <label>Categor√≠a</label>
        <select id="categoria-prenda">
            <option>Camisas</option><option>Pantalones</option><option>Remeras & Tops</option><option>Sweaters & Buzos</option>
            <option>Blazers & Camperas</option><option>Shorts & Polleras</option><option>Monos & Vestidos</option><option>Blusas</option>
        </select>
        <label>Nombre</label><input type="text" id="nombre">
        <label>Talles (Ej: S, M, L)</label><input type="text" id="talles">
        <label>Colores (Ej: Blanco, Negro)</label><input type="text" id="colores">
        <label>Foto Principal (Link Imgur)</label><input type="text" id="img_url">
        <label>Fotos Extra (Links separados por coma)</label><textarea id="fotos_extra"></textarea>
        <label>Costo ($)</label><input type="number" id="costo" oninput="calcularVenta()">
        <label>Ganancia %</label><input type="number" id="porcentaje" value="50" oninput="calcularVenta()">
        <div class="price-box">Precio Venta: <b id="precio_final">$0</b></div>
        <button id="btn-action" onclick="guardarProducto()" class="btn-main" style="background:#d4a373; color:white;">Publicar</button>
        <button id="btn-cancel" onclick="location.reload()" style="display:none; background:none; border:none; color:red; margin-top:10px; cursor:pointer; width:100%">Cancelar</button>
    </div>
    <div class="card"><h3>Stock Actual</h3><div id="lista-productos">Cargando...</div></div>
</div>

<div id="sec-pedidos" class="section">
    <div id="lista-pedidos">Cargando...</div>
</div>

<script>
    const SUPABASE_URL = "https://hnnixqelbkuyfplnncci.supabase.co";
    const SUPABASE_KEY = "sb_publishable_zjD9Q4lUlodn7XtRwF0W_A_LttLpWGa";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    function switchTab(tab, el) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('sec-' + tab).classList.add('active');
        el.classList.add('active');
        if(tab === 'pedidos') cargarPedidos();
        if(tab === 'carga') cargarLista();
    }

    function calcularVenta() {
        const c = parseFloat(document.getElementById('costo').value) || 0;
        const p = parseFloat(document.getElementById('porcentaje').value) || 0;
        const total = Math.round(c * (1 + p/100));
        document.getElementById('precio_final').innerText = "$" + total.toLocaleString();
    }

    async function guardarProducto() {
        const id = document.getElementById('edit-id').value;
        const datos = {
            nombre: document.getElementById('nombre').value,
            precio_costo: parseFloat(document.getElementById('costo').value) || 0,
            imagen_url: document.getElementById('img_url').value,
            categoria: document.getElementById('precio_final').innerText,
            descripcion: document.getElementById('talles').value,
            marca_detalle: document.getElementById('colores').value,
            fotos: document.getElementById('fotos_extra').value,
            marca: document.getElementById('categoria-prenda').value
        };

        const { error } = id 
            ? await supabaseClient.from('productos').update(datos).eq('id', id) 
            : await supabaseClient.from('productos').insert([datos]);

        if(error) alert("Error: " + error.message); else location.reload();
    }

    async function cargarLista() {
        const { data } = await supabaseClient.from('productos').select('*');
        const contenedor = document.getElementById('lista-productos');
        contenedor.innerHTML = data.map(p => `
            <div class="prod-item">
                <img src="${p.imagen_url}" width="40" height="40" style="object-fit:cover; border-radius:5px;">
                <div style="flex-grow:1; font-size:13px;"><b>${p.nombre}</b><br><small>${p.marca}</small></div>
                <button onclick="prepararEdicion('${p.id}','${p.nombre}','${p.marca}','${p.descripcion}','${p.marca_detalle}','${p.imagen_url}','${p.fotos}', ${p.precio_costo})">‚úèÔ∏è</button>
                <button onclick="eliminarProducto('${p.id}')">üóëÔ∏è</button>
            </div>`).join('');
    }

    function prepararEdicion(id, nom, cat, tal, col, img, fots, costo) {
        document.getElementById('edit-id').value = id;
        document.getElementById('nombre').value = nom;
        document.getElementById('categoria-prenda').value = cat;
        document.getElementById('talles').value = tal;
        document.getElementById('colores').value = col;
        document.getElementById('img_url').value = img;
        document.getElementById('fotos_extra').value = fots || '';
        document.getElementById('costo').value = costo;
        document.getElementById('form-title').innerText = "Editando...";
        document.getElementById('btn-action').innerText = "Actualizar";
        document.getElementById('btn-cancel').style.display = "block";
        window.scrollTo(0,0);
        calcularVenta();
    }

    async function eliminarProducto(id) {
        if(confirm("¬øBorrar producto?")) {
            await supabaseClient.from('productos').delete().eq('id', id);
            cargarLista();
        }
    }

    async function cargarPedidos() {
        const { data } = await supabaseClient.from('pedidos').select('*').eq('estado', 'NUEVO');
        const div = document.getElementById('lista-pedidos');
        div.innerHTML = (data && data.length > 0) ? '' : '<p>No hay pedidos pendientes.</p>';
        data?.forEach(p => {
            div.innerHTML += `
                <div class="order-card">
                    <b>üë§ ${p.cliente}</b>
                    <div style="font-size:12px; margin-top:10px; background:#f9f9f9; padding:8px; border-radius:8px">${p.detalles.replace(/\n/g, '<br>')}</div>
                    <button onclick="archivar('${p.id}')" style="width:100%; margin-top:10px; cursor:pointer; padding:8px;">‚úÖ Completado / Archivar</button>
                </div>`;
        });
    }

    async function archivar(id) {
        await supabaseClient.from('pedidos').update({ estado: 'ARCHIVADO' }).eq('id', id);
        cargarPedidos();
    }

    cargarLista();
</script>
</body>
</html>
