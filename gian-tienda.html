<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - SHOWROOM</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #fdf6f0; padding: 20px; margin: 0; display: flex; flex-direction: column; align-items: center; }
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; width: 100%; max-width: 500px; }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; cursor: pointer; background: #e0e0e0; font-weight: bold; font-size: 12px; }
        .tab-btn.active { background: #d4a373; color: white; }
        .section { display: none; width: 100%; max-width: 500px; }
        .section.active { display: block; }
        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid #f0e4d7; margin-bottom: 20px; }
        label { display: block; margin-top: 10px; font-weight: 600; color: #777; font-size: 11px; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #f0e4d7; border-radius: 10px; box-sizing: border-box; }
        .price-box { background: #fdf6f0; padding: 15px; border-radius: 12px; text-align: center; margin-top: 10px; border: 1px dashed #d4a373; }
        .order-card { background: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; border-left: 5px solid #d4a373; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .order-photos { display: flex; gap: 5px; margin: 10px 0; overflow-x: auto; }
        .order-photos img { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; }
        .finance-badge { background: #f0e4d7; padding: 8px; border-radius: 8px; font-size: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 10px; }
        .btn-close { background: #28a745; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; }
        .btn-download { background: #007bff; color: white; border: none; padding: 8px; border-radius: 8px; cursor: pointer; font-size: 12px; margin-top: 5px; }
    </style>
</head>
<body>

<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('carga')">üì¶ Cargar</button>
    <button class="tab-btn" onclick="switchTab('pedidos')">üõçÔ∏è Pendientes</button>
    <button class="tab-btn" onclick="switchTab('historial')">üìú Historial</button>
</div>

<div id="sec-carga" class="section active">
    <div class="card">
        <h2 id="form-title" style="color:#d4a373; margin:0">Nueva Prenda</h2>
        <input type="hidden" id="edit-id">
        
        <label>Categor√≠a</label>
        <select id="categoria-prenda">
            <option>Camisas</option>
            <option>Pantalones</option>
            <option>Remeras & Tops</option>
            <option>Sweaters & Buzos</option>
            <option>Blazers & Camperas</option>
            <option>Shorts & Camperas</option>
            <option>Monos & Vestidos</option>
            <option>Blusas</option>
        </select>

        <label>Nombre del Producto</label>
        <input type="text" id="nombre" placeholder="Ej: Jean Wide Leg">
        
        <label>Talles (S, M, L...)</label>
        <input type="text" id="talles" placeholder="Ej: 36, 38, 40">
        
        <label>Colores (separados por coma)</label>
        <input type="text" id="colores_detalle" placeholder="Azul, Negro, Celeste">

        <label>Link Foto Principal</label>
        <input type="text" id="img_url">
        
        <label>Fotos Extra (links separados por coma)</label>
        <textarea id="fotos_extra" rows="2"></textarea>
        
        <label>Precio Costo ($)</label>
        <input type="number" id="costo" oninput="calcularVenta()">
        
        <label>Ganancia %</label>
        <input type="number" id="porcentaje" value="50" oninput="calcularVenta()">
        
        <div class="price-box">Venta Sugerida: <b id="precio_final">$0</b></div>
        
        <button onclick="guardarProducto()" class="btn-close" style="background:#d4a373">Publicar Producto</button>
    </div>
</div>

<div id="sec-pedidos" class="section">
    <div id="lista-pedidos">Cargando...</div>
</div>

<div id="sec-historial" class="section">
    <div id="lista-historial">Cargando...</div>
</div>

<script>
    const SUPABASE_URL = "https://hnnixqelbkuyfplnncci.supabase.co";
    const SUPABASE_KEY = "sb_publishable_zjD9Q4lUlodn7XtRwF0W_A_LttLpWGa";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    function switchTab(tab) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('sec-' + tab).classList.add('active');
        event.target.classList.add('active');
        if(tab === 'pedidos') cargarPedidos('NUEVO', 'lista-pedidos');
        if(tab === 'historial') cargarPedidos('ARCHIVADO', 'lista-historial');
    }

    function calcularVenta() {
        const c = parseFloat(document.getElementById('costo').value) || 0;
        const p = parseFloat(document.getElementById('porcentaje').value) || 0;
        document.getElementById('precio_final').innerText = "$" + Math.round(c * (1 + p/100)).toLocaleString();
    }

    async function guardarProducto() {
        const datos = {
            nombre: document.getElementById('nombre').value,
            precio_costo: parseFloat(document.getElementById('costo').value),
            imagen_url: document.getElementById('img_url').value,
            categoria: document.getElementById('precio_final').innerText,
            descripcion: document.getElementById('talles').value, // Talles
            marca: document.getElementById('categoria-prenda').value, // Categor√≠a Filtro
            marca_detalle: document.getElementById('colores_detalle').value, // Colores
            fotos: document.getElementById('fotos_extra').value
        };
        await supabaseClient.from('productos').insert([datos]);
        alert("¬°Publicado!"); location.reload();
    }

    async function cargarPedidos(estado, contenedorId) {
        const { data } = await supabaseClient.from('pedidos').select('*').eq('estado', estado).order('created_at', { ascending: false });
        const div = document.getElementById(contenedorId);
        div.innerHTML = data.length === 0 ? '<p>No hay registros.</p>' : '';

        data.forEach(p => {
            const fotos = p.fotos_pedido ? p.fotos_pedido.split(',') : [];
            div.innerHTML += `
                <div class="order-card">
                    <b>üë§ ${p.cliente}</b> <small>${new Date(p.created_at).toLocaleDateString()}</small>
                    <div class="order-photos">${fotos.map(f => `<img src="${f}">`).join('')}</div>
                    <div style="font-size:12px; background:#f9f9f9; padding:8px; border-radius:8px">${p.detalles.replace(/\n/g, '<br>')}</div>
                    
                    <div class="finance-badge">
                        <span>Costo: <b>$${p.total_costo.toLocaleString()}</b></span>
                        <span>Items: <b>${p.total}</b></span>
                    </div>

                    ${estado === 'NUEVO' ? `
                        <button class="btn-close" onclick="cambiarEstado('${p.id}', 'ARCHIVADO')">‚úÖ Cerrar y Archivar</button>
                        <button class="btn-download" onclick="descargarPedido('${p.cliente}', '${p.detalles}')">üì• Descargar para Blink</button>
                    ` : `<button onclick="borrarPedido('${p.id}')" style="color:red; border:none; background:none; cursor:pointer; font-size:11px; margin-top:10px">üóëÔ∏è Eliminar Permanente</button>`}
                </div>`;
        });
    }

    async function cambiarEstado(id, nuevo) {
        await supabaseClient.from('pedidos').update({ estado: nuevo }).eq('id', id);
        cargarPedidos('NUEVO', 'lista-pedidos');
    }

    async function borrarPedido(id) {
        if(confirm("¬øBorrar definitivamente?")) {
            await supabaseClient.from('pedidos').delete().eq('id', id);
            cargarPedidos('ARCHIVADO', 'lista-historial');
        }
    }

    function descargarPedido(cliente, detalles) {
        const texto = `RESUMEN DE COMPRA - ${cliente}\n--------------------------\n${detalles}`;
        const blob = new Blob([texto], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Pedido_${cliente}.txt`;
        a.click();
    }

    cargarPedidos('NUEVO', 'lista-pedidos');
</script>
</body>
</html>
